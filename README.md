# OSRM Сервер для США

## Описание
Этот проект предоставляет настроенный OSRM (Open Source Routing Machine) сервер с данными всех штатов США. 
Сервер позволяет строить маршруты для автомобилей между любыми точками в США через HTTP API.

## Требования
- Docker
- Node.js (версия 14 или выше)
- Минимум 500 ГБ свободного места на диске (для данных всех штатов)
- 16 ГБ оперативной памяти (рекомендуется)

## Быстрый старт

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd osrm-map
```

2. Установите зависимости:
```bash
npm install
```

3. Загрузите и обработайте данные всех штатов:
```bash
npm run download
```

4. Объедините данные штатов:
```bash
npm run merge
```

5. Запустите сервер:
```bash
npm run start
```

## Доступные команды

| Команда | Описание |
|---------|----------|
| `npm run download` | Загружает и обрабатывает данные всех штатов США |
| `npm run merge` | Объединяет данные всех штатов в один файл |
| `npm run start` | Запускает OSRM сервер |
| `npm run start:detach` | Запускает OSRM сервер в фоновом режиме |
| `npm run stop` | Останавливает OSRM сервер |
| `npm run clean` | Удаляет все загруженные и обработанные данные |
| `npm run build` | Пересобирает Docker образ |
| `npm run rebuild` | Полная пересборка: очистка, загрузка данных, объединение и сборка образа |
| `npm run restart` | Перезапускает OSRM сервер |

## Использование API

### Построение маршрута
```http
GET http://localhost:5000/route/v1/driving/{долгота_1},{широта_1};{долгота_2},{широта_2}
```

Параметры запроса:
- `steps=true` - включает пошаговые инструкции
- `alternatives=true` - показывает альтернативные маршруты
- `annotations=true` - добавляет дополнительную информацию о маршруте
- `geometries=geojson` - возвращает геометрию в формате GeoJSON

Пример запроса:
```http
http://localhost:5000/route/v1/driving/-119.8138,39.5296;-115.1372,36.1699?steps=true&alternatives=true&annotations=true&geometries=geojson
```

### Поиск ближайшей дороги
```http
GET http://localhost:5000/nearest/v1/driving/{долгота},{широта}
```

### Матрица расстояний
```http
GET http://localhost:5000/table/v1/driving/{координаты}
```

### Поиск изохрон
```http
GET http://localhost:5000/isochrone/v1/driving/{долгота},{широта}
```

## Структура проекта
```
osrm-map/
├── data/           # Директория с данными штатов
├── temp/           # Временная директория для обработки
├── Dockerfile      # Конфигурация Docker образа
├── docker-compose.yml          # Конфигурация Docker Compose
├── download-all-states.js      # Скрипт загрузки данных штатов
├── merge-states.js            # Скрипт объединения данных
├── package.json    # Конфигурация Node.js и команды
└── README.md       # Документация проекта
```

## Примечания
- Первая загрузка и обработка данных всех штатов может занять несколько часов
- Рекомендуется иметь стабильное интернет-соединение для загрузки данных
- После перезапуска сервера все данные сохраняются в директории `data`
- Для обновления данных штатов используйте `npm run rebuild`

## Решение проблем

### Ошибка: Недостаточно памяти
Если возникает ошибка нехватки памяти при обработке больших штатов:
1. Увеличьте размер памяти в настройках Docker
2. Обрабатывайте большие штаты (например, Калифорния, Техас) отдельно

### Ошибка: Нет доступа к порту 5000
Если порт 5000 занят:
1. Измените порт в `docker-compose.yml`
2. Перезапустите сервер: `npm run restart`

## Обновление данных
Данные штатов рекомендуется обновлять раз в месяц для получения актуальной информации о дорогах. Для обновления:
```bash
npm run rebuild
``` 